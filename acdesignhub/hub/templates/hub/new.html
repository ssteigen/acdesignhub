{% extends '__base.html' %}

{% load crispy_forms_tags %}

{% block javascript %}
{{ block.super }}
<script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
{% endblock %}

{% block content %}
  <div class="card my-2">
    <div class="card-body">
      <h2 class="card-title">Upload a new design</h2>
      <hr>
      <form id="submission" method="POST" enctype="multipart/form-data">


        {% csrf_token %}


        <div class="well">
          {{ form.original_image|as_crispy_field }}
        <div id="preview" class="my-2 p-2">
          <img src="https://via.placeholder.com/900x500&text=preview" alt="preview image">
        </div><!-- /#preview -->
      </div>

        {{ form.design_name|as_crispy_field }}

        <div class="row">
          <div class="col">
            {{ form.creator_name|as_crispy_field }}
            {{ form.creator_island|as_crispy_field }}
            {{ form.creator_code|as_crispy_field }}
          </div><!-- /.col -->

          <div class="col">
            {{ form.design_type|as_crispy_field }}
            {{ form.design_code|as_crispy_field }}
          </div><!-- /.col -->
        </div><!-- /.row -->

        {{ form.description|as_crispy_field }}

        <input type="submit" value="Submit" class="btn btn-primary">
      </form>
    </div><!-- /.card-body -->
  </div><!-- /.card -->

  <script type="text/javascript">
    (function () {

      $(document).ready(function () {

        $("input#id_original_image").change(function () {
          if (this.files && this.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
              const preview = $('div#preview');
              preview.html(
                '<img style="max-width: 100%" src="' + e.target.result + '" />'
              )

              const img = new Image();
              img.src = e.target.result;
              img.onload = function() {
                const width = this.width;
                const height = this.height;

                const worker = Tesseract.createWorker({ logger: console.log });

                (async function () {
                  await worker.load();
                  await worker.loadLanguage('eng');
                  await worker.initialize('eng');

                  async function extractText(left, top, width, height) {
                    const { data } = await worker.recognize(e.target.result, {
                      rectangle: { left, top, width, height },
                    });


                    var confidenceThreshold = 50;
                    var confidentText = [];
                    for (var word in data.words) {
                      if (data.words[word].confidence > confidenceThreshold) {
                        console.log('word');
                        console.log(data.words[word]);
                        confidentText.push(data.words[word].text);
                      }
                    }

                    return confidentText.join(' ');
                  }

                  const DESIGN_NAME_LEFT = 0.38125;   /* 488 / 1280 */
                  const DESIGN_NAME_TOP = 0.15556;    /* 112 /  720 */
                  const DESIGN_NAME_WIDTH = 0.23828;  /* 305 / 1280 */
                  const DESIGN_NAME_HEIGHT = 0.10278; /*  74 /  720 */

                  $('input#id_design_name').val(await extractText(
                    DESIGN_NAME_LEFT * width,
                    DESIGN_NAME_TOP * height,
                    DESIGN_NAME_WIDTH * width,
                    DESIGN_NAME_HEIGHT * height
                  ));

                  const CREATOR_NAME_LEFT = 0.05391;   /*  69 / 1280 */
                  const CREATOR_NAME_TOP = 0.64722;    /* 466 /  720 */
                  const CREATOR_NAME_WIDTH = 0.21563;  /* 276 / 1280 */
                  const CREATOR_NAME_HEIGHT = 0.06528; /*  47 /  720 */

                  $('input#id_creator_name').val(await extractText(
                    CREATOR_NAME_LEFT * width,
                    CREATOR_NAME_TOP * height,
                    CREATOR_NAME_WIDTH * width,
                    CREATOR_NAME_HEIGHT * height
                  ));

                  const CREATOR_ISLAND_LEFT = 0.09297;    /* 119 / 1280 */
                  const CREATOR_ISLAND_TOP = 0.71250;     /* 513 /  720 */
                  const CREATOR_ISLAND_WIDTH = 0.16719;   /* 214 / 1280 */
                  const CREATOR_ISLAND_HEIGHT = 0.05833;  /*  42 /  720 */

                  $('input#id_creator_island').val(await extractText(
                    CREATOR_ISLAND_LEFT * width,
                    CREATOR_ISLAND_TOP * height,
                    CREATOR_ISLAND_WIDTH * width,
                    CREATOR_ISLAND_HEIGHT * height
                  ));

                  const CREATOR_CODE_LEFT = 0.05391;    /*  69 / 1280 */
                  const CREATOR_CODE_TOP = 0.77361;     /* 557 /  720 */
                  const CREATOR_CODE_WIDTH = 0.21563;   /* 276 / 1280 */
                  const CREATOR_CODE_HEIGHT = 0.04167;  /*  30 /  720 */

                  $('input#id_creator_code').val(await extractText(
                    CREATOR_CODE_LEFT * width,
                    CREATOR_CODE_TOP * height,
                    CREATOR_CODE_WIDTH * width,
                    CREATOR_CODE_HEIGHT * height
                  ));

                  const DESIGN_TYPE_LEFT = 0.72188;   /* 924 / 1280 */
                  const DESIGN_TYPE_TOP = 0.71944;    /* 518 /  720 */
                  const DESIGN_TYPE_WIDTH = 0.23438;  /* 300 / 1280 */
                  const DESIGN_TYPE_HEIGHT = 0.04861; /*  35 /  720 */

                  const designType = await extractText(
                    DESIGN_TYPE_LEFT * width,
                    DESIGN_NAME_TOP * height,
                    DESIGN_TYPE_WIDTH * width,
                    DESIGN_TYPE_HEIGHT * height
                  );
                  $('select#id_design_type option').map(function () {
                    const optionText = $(this).text();
                    const optionValue = $(this).val();

                    if (designType.toLowerCase().includes(optionText.toLowerCase())) {
                      $(this).prop('selected', true);
                    }
                  });

                  const DESIGN_CODE_LEFT = 0.72188;    /* 924 / 1280 */
                  const DESIGN_CODE_TOP = 0.77361;     /* 557 /  720 */
                  const DESIGN_CODE_WIDTH = 0.23438;   /* 300 / 1280 */
                  const DESIGN_CODE_HEIGHT = 0.04167;  /*  30 /  720 */

                  $('input#id_design_code').val(await extractText(
                    DESIGN_CODE_LEFT * width,
                    DESIGN_CODE_TOP * height,
                    DESIGN_CODE_WIDTH * width,
                    DESIGN_CODE_HEIGHT * height
                  ));

                  await worker.terminate();
                })();
              };
            }

            reader.readAsDataURL(this.files[0]);
          }
        });
      })
    })();
  </script>
{% endblock %}
